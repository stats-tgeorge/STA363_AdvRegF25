{
  "hash": "49facd35657f67242a4669e70f916fdb",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: 'Chapter 4 - Poisson Regression'\nsubtitle: 'Do animals bite more during a full moon?'\nexecute:\n  eval: false\n---\n\n\n## Lab Setup\n\n1) Copy the project lab folder located at *Home -> STA363_inst_files-> labs*. If you check the box next to the folder name, then click the small gear icon you can \"copy to\" and put a copy of the folder in your newly created folder. \n2) Now, click *File-> Open Project* and navigate to the project file in the folder you just copied. \n3) You can place your responses in the file *qmd* file included. \n\n## Introduction\n\nAn article in the British Medical Journal by Bhattacharjee et al. (2000) investigated whether animals bite more often during full moons. To address this question, the researchers conducted a retrospective observational analysis of 1621 consecutive patients who presented at an English hospital ER between 1997 and 1999 with an animal bite. The data is found in *bites.csv*, and relevant R code can be found below.\n\nVariables include: \n\n- *lunar.cycle* = period of lunar cycle (1-10), where 10 = full moon \n- *n.days* = number of days in that period \n- *n.bites* = number of patients presenting with an animal bite during that period\n\nLink to the article [HERE](https://www.bmj.com/content/321/7276/1559.long)\n\n## Questions\n\n\n1.  Is there initial evidence of more bites during full moon phases?\n\n2.  Why can’t we just perform a t-test comparing full moon periods to non-full moon periods using period-level data (n=10)?\n\n3.  What options can you think of for handling the fact that Period 5 is based on only 2 lunar days? What are the modeling implications of including number of days in a period as an offset term?\n\n4.  Interpret model parameters from **fit1**.\n\n5.  Is there any evidence of lack of fit in **fit1**? What factors may lead to lack of fit?\n\n6.  Does full moon have an effect above and beyond the linear cycle trend? Interpret the coefficient and a 95% confidence interval for the *fullmoon* term in **fit3**.\n\n7.  What is **fit4** doing? Does it offer an improvement over **fit3**?\n\n8.  What evidence is there that **fit5** (which uses *bitesbyday.csv*) is the analysis performed by the authors of this paper? See the article [HERE](https://www.bmj.com/content/321/7276/1559.long).\n\n9.  Based on this analysis, does it make you more wary of animal bites during full moons?\n\n### Addressing issues of overdispersion in fit5.\n\n10. Is there evidence of lack of fit in **fit5**? Cite evidence both from a goodness of fit test and from comparing means and variances by period.\n\n11. If overdispersion goes uncorrected, what are implications for p-values and CIs for model coefficients?\n\n#### Overdispersion parameter adjustment. \nOne solution is to simply add a second parameter to inflate variances, so that $Var(Y_i)=\\phi\\lambda_i$. This is called a “quasi-Poisson” or, in general, a “quasi-likelihood” approach, because our data no longer follows a true Poisson distribution.\n\n#### Negative binomial modeling. \nAnother solution is to model response using a negative binomial distribution, so that $Y\\sim NegBinom(\\theta,p)$. This distribution comes about if $Y|λ\\sim Poisson(λ)$, but the $\\lambda$'s themselves are randomly chosen according to a gamma distribution: $\\lambda \\sim gamma(θ,\\frac{(1-p)}{p})$. In this case, $E(Y)=\\theta \\frac{p}{(1-p)}=\\mu $ and $Var(Y)=\\theta \\frac{p}{(1-p)^2} =\\mu+\\frac{\\mu^2}{\\theta}$, so that $\\frac{\\mu^2}{\\theta}$ is the amount of overdispersion.\n\n12. Compare the following estimates, tests, and intervals under usual Poisson regression, quasi-Poisson regression, and negative binomial regression:\n\n|                                | Poisson | Quasi-poisson | Negative Binomial |\n|--------------------------------|---------|---------------|-------------------|\n| $\\phi$                         |         |               |                   |\n| $SE(\\hat{\\beta}_4$)            |         |               |                   |\n| Wald-type test stat            |         |               |                   |\n| Wald-type p-value              |         |               |                   |\n| LRT-type test stat             |         |               |                   |\n| LRT-type test stat             |         |               |                   |\n| LRT-type p-value               |         |               |                   |\n| CI - profile for $e^{\\beta_4}$ |         |               |                   |\n| CI-Wald-type for $e^{\\beta_4}$ |         |               |                   |\n\n\n## Code \n\n### Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(MASS)\nlibrary(dplyr)\nlibrary(maxLik)   # will have to install first\nlibrary(ggplot2)\nlibrary(gridExtra) \n\nbites.data <- read.csv(\"data/bites.csv\")\nbites.day <- read.csv(\"data/bitesbyday.csv\")\n```\n:::\n\n\n### bites.csv: analysis and offsets\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Exploratory Data Analysis\nbites.data\n\n# Average n.bites by day for each cycle to make them comparable\nbites.data <- mutate(bites.data, avg.bites=n.bites/n.days, \n                     fullmoon = ifelse(lunar.cycle==10,1,0))\nwith(bites.data, summary(avg.bites))\nwith(bites.data, summary(n.bites))\nwith(bites.data, by(avg.bites,fullmoon,summary))\n# t.test(avg.bites~fullmoon, data=bites.data)    # produces an error -why?\n\nggplot(data = bites.data, aes(x = avg.bites)) + \n  geom_histogram(bins = 4)\nggplot(data = bites.data, aes(x = n.bites)) + \n  geom_histogram(bins = 4)\nggplot(data = bites.data, aes(x = lunar.cycle, y = avg.bites)) + \n  geom_point() + geom_smooth(method=\"lm\") \n\n# Now try modeling as Poisson counts for each cycle.\n# However, Cycle 5 contains only 2 days whereas all others have 3.  \n\n# The simplest model (Model 1) uses only an indicator for the full moon cycle\n#   plus an offset for the number of days so the counts are comparable.\nfit1 <-  glm(n.bites ~ fullmoon, family=poisson, offset=log(n.days),\n             data=bites.data)\nsummary(fit1)\nexp(fit1$coef)\nexp(confint(fit1))\n\n# Alternative (Wald) confidence intervals\nfit1coef <- summary(fit1)$coefficients[,1]\nfit1se <- summary(fit1)$coefficients[,2]\nlb <- fit1coef - qnorm(.975)*fit1se\nub <- fit1coef + qnorm(.975)*fit1se\ncbind(exp(lb),exp(ub))\n\n#Signs of lack-of-fit with Simple Model\ngof <- 1-pchisq(fit1$deviance, fit1$df.residual)\ngof \n\n# Model 2:  Linear cycle trend\nfit2 <-  glm(n.bites ~ lunar.cycle, family=poisson, offset=log(n.days),\n             data=bites.data)\nsummary(fit2)\ngof <- 1-pchisq(fit2$deviance, fit2$df.residual)\ngof \n\n# Model 3: Does full moon have effect above and beyond linear cycle trend?\nfit3 <- glm(n.bites ~ lunar.cycle + fullmoon, family=poisson, \n            offset=log(n.days), data=bites.data)\nsummary(fit3)\nexp(fit3$coef)\nexp(confint(fit3))\nanova(fit2, fit3, test = \"Chisq\")\ngof <- 1-pchisq(fit3$deviance, fit3$df.residual)\ngof \n\n# Model 4: What does this model do?\nbites.data4 <- mutate(bites.data, dist = c(3,6,9,12,14.5,12,9,6,3,0))\nfit2a <- glm(n.bites ~ dist, family=poisson, offset=log(n.days), data=bites.data4)\nsummary(fit2a)\n\nfit4 <- glm(n.bites ~ dist + fullmoon, family=poisson, offset=log(n.days),\n            data=bites.data4)\nsummary(fit4)\n```\n:::\n\n\n### bitesbyday.csv: analysis and overdispersion\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Model 5: Try to replicate model from paper, using daily data I transcribed \n#          from Figure 1 and matched to period totals\nbites.day <- bites.day %>%\n  mutate(period = factor(period, levels = c(5,1:4,6:10)),\n         period_no4 = factor(period_no4, levels = c(5, 1:3, 6:10))\n)\n\nfit5 <- glm(bites ~ period, family=poisson, data=bites.day)\nsummary(fit5)\nexp(fit5$coef)\nexp(confint(fit5))\ngof <- 1-pchisq(fit5$deviance, fit5$df.residual)\ngof \n\nfit5reduced <- glm(bites ~ period_no4, family = poisson, data = bites.day)\nsummary(fit5reduced)\nanova(fit5reduced, fit5, test = \"Chisq\")\n\n# Alternative (Wald) confidence intervals\nfit5coef <- summary(fit5)$coefficients[,1]\nfit5se <- summary(fit5)$coefficients[,2]\nlb <- fit5coef - qnorm(.975)*fit5se\nub <- fit5coef + qnorm(.975)*fit5se\ncbind(exp(lb),exp(ub))\n\n\n# Might overdispersion be a factor in lack of fit?\nbites.day %>%\n  group_by(period) %>%\n  summarise(count = n(),\n            mean_bites = mean(bites),\n            var_bites = var(bites))\n\n\n# Adjust fit1 for overdispersion\nfit5a <- glm(bites ~ period, family=quasipoisson, data=bites.day)\nsummary(fit5a)\nexp(confint(fit5a))\n\nfit5areduced <- glm(bites ~ period_no4, family = quasipoisson, data = bites.day)\nsummary(fit5areduced)\nanova(fit5areduced, fit5a, test = \"F\")\n\nphi <- sum(resid(fit5, type='pearson')^2) / fit5$df.residual\nphi\ndrop.in.dev <- fit5reduced$deviance - fit5$deviance\ndiff.in.df <- fit5reduced$df.residual - fit5$df.residual\nFstat <- drop.in.dev / summary(fit5a)$dispersion\nFstat\n1-pf(Fstat, diff.in.df, fit5$df.residual)\n\n# Alternative (Wald) confidence intervals with QL\nfit5acoef <- summary(fit5a)$coefficients[,1]\nfit5ase <- summary(fit5a)$coefficients[,2]\nlb <- fit5acoef - qt(.975, fit5a$df.residual)*fit5ase\nub <- fit5acoef + qt(.975, fit5a$df.residual)*fit5ase\ncbind(exp(lb),exp(ub))\n\n\n# Model fit1 using negative binomial\nfit5b <- glm.nb(bites ~ period, data=bites.day)\nsummary(fit5b)\nexp(confint(fit5b))\n\nfit5breduced <- glm.nb(bites ~ period_no4, data = bites.day)\nsummary(fit5breduced)\nanova(fit5breduced, fit5b, test = \"Chisq\")\n\n# Alternative (Wald) confidence intervals with NB\nfit5bcoef <- summary(fit5b)$coefficients[,1]\nfit5bse <- summary(fit5b)$coefficients[,2]\nlb <- fit5bcoef - qnorm(.975)*fit5bse\nub <- fit5bcoef + qnorm(.975)*fit5bse\ncbind(exp(lb),exp(ub))\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}